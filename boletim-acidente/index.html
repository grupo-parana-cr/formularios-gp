<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Boletim de Acidente - Grupo Paran√°</title>
  <style>
    :root {
      --primary-blue:#004AC9; --primary-red:#ed383b; --dark-blue:#003580;
      --light-gray:#F5F7FA; --text-primary:#2C3E50; --text-secondary:#7F8C8D;
      --border-color:#E0E6ED; --success-green:#27AE60; --error-red:#E74C3C; --white:#FFF;
      --disabled-gray:#9aa3af;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,sans-serif;background:var(--light-gray);color:var(--text-primary);line-height:1.6;-webkit-font-smoothing:antialiased}
    .container{max-width:600px;margin:0 auto;background:var(--white);min-height:100vh}
    .header{background:linear-gradient(135deg,var(--primary-blue),var(--dark-blue));color:#fff;padding:24px 20px 32px;text-align:center;box-shadow:0 4px 20px rgba(0,74,201,.2)}
    .logo{background:#fff;padding:12px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.15);margin:0 auto 20px;max-width:100px}
    .header h1{font-size:1.5em;font-weight:700;margin-bottom:8px}
    .header p{font-size:.9em;opacity:.95}
    .form-container{padding:24px 20px}
    .form-section{margin-bottom:24px}
    .section-title{color:var(--primary-blue);font-size:.85em;font-weight:700;text-transform:uppercase;letter-spacing:.5px;margin-bottom:16px;padding-bottom:8px;border-bottom:2px solid var(--primary-red)}
    .form-group{margin-bottom:20px}
    label{display:block;font-weight:600;color:var(--text-primary);margin-bottom:8px;font-size:.95em}
    label.required::after{content:" *";color:var(--error-red)}
    label.optional{font-weight:500;color:var(--text-secondary)}
    label.optional::after{content:" (opcional)";font-size:.85em;font-weight:400}
    input[type="text"],input[type="date"],input[type="time"],input[type="tel"],textarea,select{width:100%;padding:14px 16px;border:2px solid var(--border-color);border-radius:10px;font-size:16px;transition:.3s;background:#fff;color:var(--text-primary);display:block}
    input[type="date"],input[type="time"]{-webkit-appearance:none;appearance:none}
    input:focus,textarea:focus,select:focus{outline:none;border-color:var(--primary-blue);box-shadow:0 0 0 3px rgba(0,74,201,.1)}
    textarea{resize:vertical;min-height:120px;line-height:1.6}
    .radio-group{display:flex;gap:12px;flex-wrap:wrap}
    .radio-item{flex:1;min-width:140px}
    .radio-item input{display:none}
    .radio-item label{display:block;padding:14px 20px;border:2px solid var(--border-color);border-radius:10px;text-align:center;cursor:pointer;transition:.3s;font-weight:600;background:#fff}
    .radio-item input:checked+label{background:var(--primary-blue);color:#fff;border-color:var(--primary-blue);transform:scale(1.02)}
    .photo-upload-area{border:2px dashed var(--border-color);border-radius:12px;padding:24px;text-align:center;cursor:pointer;transition:.3s;background:var(--light-gray)}
    .photo-upload-area.dragover{border-color:var(--primary-blue);background:rgba(0,74,201,.05)}
    .photo-icon{font-size:3em;margin-bottom:12px}
    .photo-text{font-weight:600;margin-bottom:6px}
    .photo-hint{font-size:.85em;color:var(--text-secondary)}
    .photo-preview-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:12px;margin-top:16px}
    .photo-preview-item{position:relative;border-radius:10px;overflow:hidden;aspect-ratio:1;box-shadow:0 2px 8px rgba(0,0,0,.1)}
    .photo-preview-item img{width:100%;height:100%;object-fit:cover}
    .photo-remove-btn{position:absolute;top:6px;right:6px;background:var(--error-red);color:#fff;border:none;border-radius:50%;width:28px;height:28px;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,.3)}
    .whatsapp-option{display:flex;align-items:center;gap:12px;padding:16px;background:var(--light-gray);border-radius:10px;margin-bottom:12px;cursor:pointer;user-select:none}
    .whatsapp-option input{width:24px;height:24px;cursor:pointer;flex-shrink:0}
    .whatsapp-input-container{display:none;margin-top:12px}
    .whatsapp-input-container.show{display:block;animation:slideDown .3s ease}
    @keyframes slideDown{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
    .submit-container{position:sticky;bottom:0;padding:16px 20px;background:#fff;border-top:1px solid var(--border-color);box-shadow:0 -4px 20px rgba(0,0,0,.05)}
    .submit-btn{width:100%;padding:16px;background:linear-gradient(135deg,var(--primary-red),#c92f32);color:#fff;border:none;border-radius:12px;font-size:1.1em;font-weight:700;cursor:pointer;box-shadow:0 4px 15px rgba(237,56,59,.3)}
    .submit-btn.loading::after{content:"";margin-left:8px;display:inline-block;width:16px;height:16px;border:2px solid #fff;border-radius:50%;border-top-color:transparent;animation:spin .8s linear infinite}
    .submit-btn:disabled{background:var(--disabled-gray)!important;box-shadow:none;cursor:not-allowed;opacity:1}
    .submit-hint{font-size:.78rem;color:var(--text-secondary);margin-top:6px;text-align:center}
    @keyframes spin{to{transform:rotate(360deg)}}
    .error-message{color:var(--error-red);font-size:.85em;margin-top:6px;display:none}
    .form-group.error input,.form-group.error textarea,.form-group.error select{border-color:var(--error-red)}
    .form-group.error .error-message{display:block}
    .success-modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:1000;align-items:center;justify-content:center;padding:20px}
    .success-modal.show{display:flex}
    .success-content{background:#fff;padding:32px 24px;border-radius:16px;text-align:center;max-width:90%;width:460px;animation:modalPop .4s ease}
    @keyframes modalPop{from{opacity:0;transform:scale(.9)}to{opacity:1;transform:scale(1)}}
    .success-icon{font-size:3.6em;margin-bottom:12px}
    .success-content h2{color:var(--success-green);margin-bottom:8px}
    .meta p{margin:4px 0}
    .meta .label{color:#2453a6;font-weight:700}
    .success-actions{display:flex;gap:10px;justify-content:center;margin-top:12px}
    .success-btn{padding:12px 20px;background:var(--primary-blue);color:#fff;border:none;border-radius:10px;font-weight:700;cursor:pointer}
    .success-btn.secondary{background:#6b7280}
    #thanks{display:none;color:var(--text-secondary);margin-top:12px}
    #whatsConfirm{display:none;font-size:.95em;color:var(--text-secondary);margin-top:10px}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <img src="../img/logo-grupo-parana.png" alt="Logo Grupo Paran√°" class="logo">
      <h1>‚ö†Ô∏è Boletim de Acidente</h1>
      <p>Registro Inicial de Ocorr√™ncia</p>
    </div>

    <form id="boletimForm" class="form-container" novalidate>
      <div class="form-section">
        <div class="section-title">üìã Tipo de Ocorr√™ncia</div>
        <div class="form-group">
          <label class="required">Selecione o tipo</label>
          <div class="radio-group">
            <div class="radio-item">
              <input type="radio" id="tipoAcidente" name="tipo" value="acidente" required>
              <label for="tipoAcidente">üö® Acidente</label>
            </div>
            <div class="radio-item">
              <input type="radio" id="tipoIncidente" name="tipo" value="incidente" required>
              <label for="tipoIncidente">‚ö†Ô∏è Incidente</label>
            </div>
          </div>
          <div class="error-message">Selecione o tipo de ocorr√™ncia</div>
        </div>
      </div>

      <div class="form-section">
        <div class="section-title">üìÖ Data e Hora</div>
        <div class="form-group">
          <label for="data" class="required">Data</label>
          <input type="date" id="data" name="data" required>
          <div class="error-message">Campo obrigat√≥rio</div>
        </div>
        <div class="form-group">
          <label for="hora" class="required">Hora</label>
          <input type="time" id="hora" name="hora" required>
          <div class="error-message">Campo obrigat√≥rio</div>
        </div>
      </div>

      <div class="form-section">
        <div class="section-title">üìç Local</div>
        <div class="form-group">
          <label for="local" class="required">Endere√ßo/Local da ocorr√™ncia</label>
          <input type="text" id="local" name="local" placeholder="Ex: Rua Leandro Ortiz Menezes n.401" required>
          <div class="error-message">Campo obrigat√≥rio</div>
        </div>
      </div>

      <div class="form-section">
        <div class="section-title">üè¢ Dados Gerais</div>
        <div class="form-group">
          <label for="empresa" class="required">Empresa</label>
          <input type="text" id="empresa" name="empresa" placeholder="Nome da empresa" required>
          <div class="error-message">Campo obrigat√≥rio</div>
        </div>
      </div>

      <div class="form-section">
        <div class="section-title">üì¢ Quem est√° reportando</div>
        <div class="form-group">
          <label for="comunicante" class="required">Seu nome (quem est√° registrando)</label>
          <input type="text" id="comunicante" name="comunicante" placeholder="Seu nome completo" required>
          <div class="error-message">Campo obrigat√≥rio</div>
        </div>
      </div>

      <div class="form-section">
        <div class="section-title">üë§ Pessoa Envolvida no Acidente</div>
        <div class="form-group">
          <label for="colaborador" class="required">Nome da pessoa acidentada</label>
          <input type="text" id="colaborador" name="colaborador" placeholder="Nome completo da v√≠tima" required>
          <div class="error-message">Campo obrigat√≥rio</div>
        </div>
      </div>

      <div class="form-section">
        <div class="section-title">üìù Breve Relato</div>
        <div class="form-group">
          <label for="relato" class="required">Descreva o ocorrido</label>
          <textarea id="relato" name="relato" placeholder="Descreva brevemente o que aconteceu..." required></textarea>
          <div class="error-message">Campo obrigat√≥rio</div>
        </div>
      </div>

      <div class="form-section">
        <div class="section-title">üì∑ Fotos</div>
        <div class="form-group">
          <label class="optional">Fotos do local/acidente</label>
          <div class="photo-upload-area" id="photoUploadArea">
            <div class="photo-icon">üì∏</div>
            <div class="photo-text">Toque para adicionar fotos</div>
            <div class="photo-hint">C√¢mera ou Galeria ‚Ä¢ M√°ximo 5 fotos ‚Ä¢ At√© 5MB cada</div>
            <input type="file" id="photoInput" accept="image/*" multiple style="display:none">
          </div>
          <div class="photo-preview-grid" id="photoPreviewGrid"></div>
        </div>
      </div>

      <div class="form-section">
        <div class="section-title">üí¨ Notifica√ß√£o WhatsApp</div>
        <div class="whatsapp-option" onclick="document.getElementById('receberWhatsapp').click();">
          <span class="whatsapp-icon">üì±</span>
          <input type="checkbox" id="receberWhatsapp" name="receberWhatsapp" onclick="event.stopPropagation();">
          <label for="receberWhatsapp" onclick="event.stopPropagation();">Quero receber uma c√≥pia via WhatsApp</label>
        </div>
        <div class="whatsapp-input-container" id="whatsappInputContainer">
          <div class="form-group">
            <label for="whatsapp" class="optional">Meu n√∫mero de WhatsApp</label>
            <input type="tel" id="whatsapp" name="whatsapp" placeholder="(67) 99921-7329" maxlength="15">
            <div class="error-message">N√∫mero inv√°lido</div>
          </div>
        </div>
      </div>
    </form>

    <div class="submit-container">
      <button type="submit" form="boletimForm" class="submit-btn" id="submitBtn">Enviar Boletim</button>
      <div class="submit-hint">Isso pode levar alguns segundos.</div>
    </div>
  </div>

  <!-- Modal -->
  <div class="success-modal" id="successModal">
    <div class="success-content">
      <div class="success-icon">‚úÖ</div>
      <h2>Tudo certo!</h2>
      <div class="meta" id="successMeta">
        <p><span class="label">Protocolo:</span> <span id="proto">‚Äî</span></p>
        <p><span class="label">Tipo:</span> <span id="tipo">‚Äî</span></p>
      </div>
      <div id="successBody">
        <p>O registro foi enviado com sucesso.</p>
        <p id="whatsConfirm">üì± Em breve voc√™ receber√° uma confirma√ß√£o.</p>
      </div>
      <div id="thanks" style="display:none;"><strong>Obrigado!</strong><br>Sua ocorr√™ncia foi registrada e nossa equipe dar√° sequ√™ncia.</div>
      <div class="success-actions" id="successActions">
        <button class="success-btn" id="btnRegistrarNovo">Registrar Novo</button>
        <button class="success-btn secondary" id="btnFinalizar">Finalizar</button>
      </div>
    </div>
  </div>

  <script>
    let uploadedPhotos = [];
    const maxPhotos=5, maxFileSize=5*1024*1024;

    // WhatsApp mask
    const whatsappInput=document.getElementById('whatsapp');
    whatsappInput.addEventListener('input',e=>{
      let v=e.target.value.replace(/\D/g,'');
      if(v.length<=11){ v=v.replace(/^(\d{2})(\d)/g,'($1) $2'); v=v.replace(/(\d)(\d{4})$/,'$1-$2'); }
      e.target.value=v;
    });

    document.getElementById('receberWhatsapp').addEventListener('change',e=>{
      const c=document.getElementById('whatsappInputContainer');
      if(e.target.checked){ c.classList.add('show'); whatsappInput.focus(); }
      else { c.classList.remove('show'); whatsappInput.value=''; }
    });

    // Fotos
    const photoUploadArea=document.getElementById('photoUploadArea');
    const photoInput=document.getElementById('photoInput');
    const photoPreviewGrid=document.getElementById('photoPreviewGrid');
    photoUploadArea.addEventListener('click',()=>{ if(uploadedPhotos.length<maxPhotos) photoInput.click(); else alert(`M√°ximo de ${maxPhotos} fotos permitidas`); });
    photoUploadArea.addEventListener('dragover',e=>{ e.preventDefault(); photoUploadArea.classList.add('dragover'); });
    photoUploadArea.addEventListener('dragleave',()=> photoUploadArea.classList.remove('dragover'));
    photoUploadArea.addEventListener('drop',e=>{ e.preventDefault(); photoUploadArea.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });
    photoInput.addEventListener('change',e=> handleFiles(e.target.files));
    function handleFiles(files){
      for(let file of files){
        if(uploadedPhotos.length>=maxPhotos){ alert(`M√°ximo de ${maxPhotos} fotos permitidas`); break; }
        if(!file.type.startsWith('image/')){ alert('Apenas imagens s√£o permitidas'); continue; }
        if(file.size>maxFileSize){ alert(`${file.name} excede o tamanho m√°ximo de 5MB`); continue; }
        uploadedPhotos.push(file); createPhotoPreview(file, uploadedPhotos.length-1);
      }
      photoInput.value='';
    }
    function createPhotoPreview(file,index){
      const reader=new FileReader();
      reader.onload=e=>{
        const div=document.createElement('div');
        div.className='photo-preview-item';
        div.innerHTML=`<img src="${e.target.result}" alt="Foto ${index+1}"><button type="button" class="photo-remove-btn" onclick="removePhoto(${index})">√ó</button>`;
        photoPreviewGrid.appendChild(div);
      };
      reader.readAsDataURL(file);
    }
    function removePhoto(index){ uploadedPhotos.splice(index,1); photoPreviewGrid.innerHTML=''; uploadedPhotos.forEach((f,i)=>createPhotoPreview(f,i)); }

    // Modal
    function showSuccessModal(data){
      const modal=document.getElementById('successModal');
      const whatsChecked=document.getElementById('receberWhatsapp').checked;
      const whatsConfirm=document.getElementById('whatsConfirm');
      whatsConfirm.style.display = whatsChecked ? 'block' : 'none';

      const proto = (data?.data?.registroId || data?.registroId || 'N/A');
      const tipo  = ((data?.data?.tipo || data?.tipo || 'N/A') + '').toUpperCase();
      document.getElementById('proto').textContent = proto;
      document.getElementById('tipo').textContent = tipo;

      modal.classList.add('show');
    }

    document.getElementById('btnRegistrarNovo').addEventListener('click',()=>location.reload());
    document.getElementById('btnFinalizar').addEventListener('click',()=>{
      document.getElementById('successActions').style.display='none';
      document.getElementById('thanks').style.display='block';
      setTimeout(()=>location.reload(),1400);
    });

    function validateForm(){
      let ok=true; const form=document.getElementById('boletimForm');
      form.querySelectorAll('.form-group').forEach(g=>g.classList.remove('error'));
      form.querySelectorAll('[required]').forEach(f=>{ if(!f.value.trim() && f.type!=='radio'){ f.closest('.form-group').classList.add('error'); ok=false; } });
      const tipo=form.querySelector('input[name="tipo"]:checked'); if(!tipo){ form.querySelector('input[name="tipo"]').closest('.form-group').classList.add('error'); ok=false; }
      if(document.getElementById('receberWhatsapp').checked){
        const v=whatsappInput.value.replace(/\D/g,'');
        if(v.length!==11){ whatsappInput.closest('.form-group').classList.add('error'); ok=false; }
      }
      return ok;
    }

    document.getElementById('boletimForm').addEventListener('submit',async e=>{
      e.preventDefault();
      if(!validateForm()){ alert('Por favor, preencha todos os campos obrigat√≥rios corretamente.'); return; }

      const btn=document.getElementById('submitBtn');
      btn.disabled=true;
      btn.classList.add('loading');
      btn.textContent='Enviando üöÄ Aguarde na tela';

      const fd=new FormData();
      fd.append('tipo',document.querySelector('input[name="tipo"]:checked').value);
      fd.append('data',document.getElementById('data').value);
      fd.append('hora',document.getElementById('hora').value);
      fd.append('local',document.getElementById('local').value);
      fd.append('empresa',document.getElementById('empresa').value);
      fd.append('comunicante',document.getElementById('comunicante').value);
      fd.append('colaborador',document.getElementById('colaborador').value);
      fd.append('relato',document.getElementById('relato').value);
      fd.append('receberWhatsapp',document.getElementById('receberWhatsapp').checked);
      if(document.getElementById('receberWhatsapp').checked){ fd.append('whatsapp',whatsappInput.value.replace(/\D/g,'')); }
      uploadedPhotos.forEach((p,i)=>fd.append(`foto_${i}`,p));

      try{
        const r=await fetch('https://grupoparana-n8n.qkcade.easypanel.host/webhook-test/boletim-acidente',{method:'POST',body:fd});
        const data=await r.json();
        if(r.ok && (data.success || data.data)){ showSuccessModal(data); }
        else { throw new Error(data?.message || 'Erro ao enviar formul√°rio'); }
      }catch(err){
        console.error(err);
        alert('Ops, algo saiu do previsto. Tente novamente.');
      }finally{
        btn.disabled=false;
        btn.classList.remove('loading');
        btn.textContent='Enviar Boletim';
      }
    });

    // Auto-preencher data/hora como na V1
    const now=new Date();
    document.getElementById('data').valueAsDate = now;
    document.getElementById('hora').value = now.toTimeString().slice(0,5);
  </script>
</body>
</html>
