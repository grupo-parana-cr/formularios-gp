/**
 * ============================================
 * üî• SCRIPT CORRIGIDO E CONSOLIDADO
 * Grupo Paran√° - Solicita√ß√£o de Contratos
 * 
 * VERS√ÉO: 2.0 (Sem duplicidades)
 * DATA: 10/11/2025
 * STATUS: ‚úÖ Pronto para Produ√ß√£o
 * ============================================
 */

'use strict';

// ============================================
// 1Ô∏è‚É£ HELPERS GLOBAIS (in√≠cio do script)
// ============================================

const $ = (selector) => document.querySelector(selector);
const $$ = (selector) => document.querySelectorAll(selector);

// Modo de opera√ß√£o
const PRODUCTION_MODE = false; // false = teste, true = produ√ß√£o

// ============================================
// 2Ô∏è‚É£ CONSTANTES GLOBAIS
// ============================================

const REGEX_EMAIL = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/i;
const REGEX_CPF = /^\d{11}$/;
const REGEX_CNPJ = /^\d{14}$/;

// Estado global
window._lastCPFError = '';
window._lastCNPJError = '';
window.selectedEmpresas = [];
let uploadedFiles = [];
let selectedContractType = null;
let currentSection = 1;
const totalSections = 8;

// ============================================
// 3Ô∏è‚É£ FUN√á√ïES AUXILIARES
// ============================================

/**
 * üî• √öNICA VERS√ÉO: Apenas D√≠gitos
 */
function onlyDigits(str) {
  return (str || '').replace(/\D/g, '');
}

/**
 * üî• VERIFICAR CAMPO VIS√çVEL
 */
function isVisible(el) {
  if (!el) return false;
  if (el.getClientRects().length === 0) return false;
  const style = window.getComputedStyle(el);
  return style.display !== 'none' && 
         style.visibility !== 'hidden' && 
         parseFloat(style.opacity) !== 0;
}

/**
 * üî• FORMATAR TAMANHO DE ARQUIVO
 */
function formatFileSize(bytes) {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

/**
 * üî• NORMALIZAR TEXTO PARA TITLE CASE
 */
function toTitleCase(texto) {
  if (!texto || texto === 'N/A' || texto === null) return 'N/A';
  
  texto = String(texto).trim();
  if (!texto) return 'N/A';
  
  return texto
    .toLowerCase()
    .split(/(\s+)/)
    .map(palavra => {
      if (!palavra || /^\s+$/.test(palavra)) return palavra;
      return palavra.charAt(0).toUpperCase() + palavra.slice(1);
    })
    .join('');
}

// ============================================
// 4Ô∏è‚É£ M√ÅSCARAS DE ENTRADA (√öNICA VERS√ÉO)
// ============================================

/**
 * üî• M√ÅSCARA √öNICA PARA CPF
 * Formato: 999.999.999-99
 */
function maskCPF(value) {
  let digits = onlyDigits(value).substring(0, 11);
  if (!digits) return '';
  return digits.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
}

/**
 * üî• M√ÅSCARA √öNICA PARA CNPJ
 * Formato: 99.999.999/9999-99
 */
function maskCNPJ(value) {
  let digits = onlyDigits(value).substring(0, 14);
  if (!digits) return '';
  return digits.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
}

/**
 * üî• M√ÅSCARA √öNICA PARA TELEFONE BRASILEIRO
 * Celular: (XX) 9XXXX-XXXX
 * Fixo: (XX) XXXX-XXXX
 */
function maskPhone(value) {
  let digits = onlyDigits(value);
  
  if (!digits) return '';
  
  if (digits.length <= 8) {
    // Sem DDD, formato 4x4
    return digits.replace(/(\d{4})(\d{4})/, '$1-$2');
  } else if (digits.length <= 10) {
    // Fixo: (XX) XXXX-XXXX
    return digits.replace(/(\d{2})(\d)/, '($1) $2')
                 .replace(/(\d{4})(\d)/, '$1-$2');
  } else {
    // Celular: (XX) 9XXXX-XXXX
    return digits.replace(/(\d{2})(\d)/, '($1) $2')
                 .replace(/(\d{5})(\d)/, '$1-$2');
  }
}

/**
 * üî• M√ÅSCARA √öNICA PARA MOEDA BRASILEIRA
 * Formato: 1.234.567,89
 */
function maskCurrency(value) {
  if (!value) return '';
  
  let digits = onlyDigits(value);
  
  if (!digits) return '';
  
  // Garantir m√≠nimo 3 d√≠gitos (ex: 1 ‚Üí 001)
  digits = digits.padStart(3, '0');
  
  // Separar parte inteira e decimal
  const intPart = digits.slice(0, -2) || '0';
  const decPart = digits.slice(-2);
  
  // Formatar parte inteira com separador de milhar
  const formatted = intPart.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
  
  return `${formatted},${decPart}`;
}

/**
 * üî• NORMALIZAR TELEFONE RECEBIDO DA API
 * A API pode retornar dados incompletos - esta fun√ß√£o NORMALIZA
 */
function normalizeTelefoneAPI(telefone) {
  if (!telefone || telefone === 'N/A') return 'N/A';
  
  let apenasNumeros = onlyDigits(telefone);
  
  if (!apenasNumeros) return 'N/A';
  
  // Remover 0 de interurbano antigo
  if (apenasNumeros.startsWith('0')) {
    apenasNumeros = apenasNumeros.substring(1);
  }
  
  // üîë L√ìGICA CENTRALIZADA
  if (apenasNumeros.length === 9) {
    // 9 d√≠gitos = celular sem DDD
    if (apenasNumeros.startsWith('9')) {
      return `9${apenasNumeros.substring(0, 4)}-${apenasNumeros.substring(4)}`;
    } else {
      // Adicionar 9 no in√≠cio
      return `9${apenasNumeros.substring(0, 4)}-${apenasNumeros.substring(4)}`;
    }
  } else if (apenasNumeros.length === 10) {
    // 10 d√≠gitos = fixo com DDD
    const ddd = apenasNumeros.substring(0, 2);
    const numero = apenasNumeros.substring(2);
    return `(${ddd}) ${numero.substring(0, 4)}-${numero.substring(4)}`;
  } else if (apenasNumeros.length === 11) {
    // 11 d√≠gitos = celular com DDD
    const ddd = apenasNumeros.substring(0, 2);
    const numero = apenasNumeros.substring(2);
    if (numero.startsWith('9')) {
      return `(${ddd}) ${numero.substring(0, 5)}-${numero.substring(5)}`;
    } else {
      // Adicionar 9 (API retornou incompleto)
      return `(${ddd}) 9${numero.substring(0, 4)}-${numero.substring(4)}`;
    }
  } else if (apenasNumeros.length === 12) {
    // 12 d√≠gitos (raro)
    const ddd = apenasNumeros.substring(0, 2);
    const numero = apenasNumeros.substring(2);
    return `(${ddd}) ${numero.substring(0, 5)}-${numero.substring(5)}`;
  } else {
    // Tamanho inesperado
    return apenasNumeros;
  }
}

// ============================================
// 5Ô∏è‚É£ VALIDA√á√ïES (√öNICA VERS√ÉO)
// ============================================

/**
 * üî• VALIDA√á√ÉO √öNICA PARA CPF
 */
window.isValidCPF = function(cpf) {
  const s = onlyDigits(cpf);
  
  if (s.length !== 11) {
    window._lastCPFError = 'CPF deve conter 11 d√≠gitos.';
    return false;
  }
  
  if (/^(\d)\1{10}$/.test(s)) {
    window._lastCPFError = 'CPF inv√°lido (d√≠gitos repetidos).';
    return false;
  }
  
  const n = s.split('').map(Number);
  
  // Primeiro verificador
  let sum = 0;
  for (let i = 0; i < 9; i++) sum += n[i] * (10 - i);
  let d1 = 11 - (sum % 11);
  if (d1 >= 10) d1 = 0;
  if (d1 !== n[9]) {
    window._lastCPFError = 'CPF com d√≠gito verificador inv√°lido.';
    return false;
  }
  
  // Segundo verificador
  sum = 0;
  for (let i = 0; i < 10; i++) sum += n[i] * (11 - i);
  let d2 = 11 - (sum % 11);
  if (d2 >= 10) d2 = 0;
  if (d2 !== n[10]) {
    window._lastCPFError = 'CPF com d√≠gito verificador inv√°lido.';
    return false;
  }
  
  window._lastCPFError = '';
  return true;
};

/**
 * üî• VALIDA√á√ÉO √öNICA PARA CNPJ
 */
window.isValidCNPJ = function(cnpj) {
  const s = onlyDigits(cnpj);
  
  if (s.length !== 14) {
    window._lastCNPJError = 'CNPJ deve conter 14 d√≠gitos.';
    return false;
  }
  
  if (/^(\d)\1{13}$/.test(s)) {
    window._lastCNPJError = 'CNPJ inv√°lido (d√≠gitos repetidos).';
    return false;
  }
  
  const calcDigit = (digs) => {
    let pos = digs.length - 7;
    let sum = 0;
    for (let i = 0; i < digs.length; i++) {
      sum += parseInt(digs[i]) * pos--;
      if (pos < 2) pos = 9;
    }
    const result = sum % 11;
    return result < 2 ? 0 : 11 - result;
  };
  
  const first12 = s.substring(0, 12);
  const digit1 = calcDigit(first12);
  const digit2 = calcDigit(first12 + digit1);
  
  if (s !== first12 + digit1 + digit2) {
    window._lastCNPJError = 'CNPJ com d√≠gito verificador inv√°lido.';
    return false;
  }
  
  window._lastCNPJError = '';
  return true;
};

// ============================================
// 6Ô∏è‚É£ LISTENER √öNICO DE VALIDA√á√ÉO
// ============================================

(function() {
  'use strict';
  
  // Setup campos email
  function setupEmailFields() {
    const emailFields = document.querySelectorAll(
      'input[type="email"], input[name*="email" i], input[id*="email" i]'
    );
    
    emailFields.forEach(el => {
      if (el.dataset._emailSetup === '1') return;
      el.dataset._emailSetup = '1';
      
      el.type = 'email';
      el.setAttribute('pattern', REGEX_EMAIL.source);
      if (!el.placeholder) el.placeholder = 'nome@empresa.com.br';
      
      el.addEventListener('blur', validateEmail);
      el.addEventListener('input', validateEmail);
    });
  }
  
  function validateEmail(e) {
    const v = (e.target.value || '').trim();
    if (v && !REGEX_EMAIL.test(v)) {
      e.target.setCustomValidity('E-mail inv√°lido');
      e.target.classList.add('error');
    } else {
      e.target.setCustomValidity('');
      e.target.classList.remove('error');
    }
  }
  
  // Setup campos documento
  function setupDocumentFields() {
    const cpfFields = document.querySelectorAll(
      'input[id*="cpf" i], input[name*="cpf" i], input[data-field*="_cpf"]'
    );
    const cnpjFields = document.querySelectorAll(
      'input[id*="cnpj" i], input[name*="cnpj" i], input[data-field*="_cnpj"]'
    );
    
    cpfFields.forEach(el => {
      if (el.dataset._cpfSetup === '1') return;
      el.dataset._cpfSetup = '1';
      el.addEventListener('blur', () => validateCPFField(el));
      el.addEventListener('input', () => validateCPFField(el));
    });
    
    cnpjFields.forEach(el => {
      if (el.dataset._cnpjSetup === '1') return;
      el.dataset._cnpjSetup = '1';
      el.addEventListener('blur', () => validateCNPJField(el));
      el.addEventListener('input', () => validateCNPJField(el));
    });
  }
  
  function validateCPFField(el) {
    const v = (el.value || '').trim();
    if (!v) {
      el.setCustomValidity('');
      el.classList.remove('error');
      return;
    }
    
    if (!window.isValidCPF(v)) {
      el.setCustomValidity(window._lastCPFError || 'CPF inv√°lido');
      el.classList.add('error');
    } else {
      el.setCustomValidity('');
      el.classList.remove('error');
    }
  }
  
  function validateCNPJField(el) {
    const v = (el.value || '').trim();
    if (!v) {
      el.setCustomValidity('');
      el.classList.remove('error');
      return;
    }
    
    if (!window.isValidCNPJ(v)) {
      el.setCustomValidity(window._lastCNPJError || 'CNPJ inv√°lido');
      el.classList.add('error');
    } else {
      el.setCustomValidity('');
      el.classList.remove('error');
    }
  }
  
  // Inicializa√ß√£o
  document.addEventListener('DOMContentLoaded', () => {
    setupEmailFields();
    setupDocumentFields();
  });
  
  // Observer para campos din√¢micos
  const observer = new MutationObserver(() => {
    setupEmailFields();
    setupDocumentFields();
  });
  
  observer.observe(document.body, {
    childList: true,
    subtree: true
  });
})();

// ============================================
// 7Ô∏è‚É£ APLICAR M√ÅSCARAS AOS CAMPOS
// ============================================

document.addEventListener('DOMContentLoaded', () => {
  // Aplicar m√°scaras de moeda
  [
    '#valorContrato',
    '#valorTotal', 
    '#valorAluguel',
    '#valorOutros',
    '#estimativaDanos'
  ].forEach(selector => {
    const el = $(selector);
    if (el) {
      el.addEventListener('input', e => {
        e.target.value = maskCurrency(e.target.value);
      });
    }
  });
  
  // Aplicar m√°scaras de telefone
  const phoneFields = $$('input[type="tel"], input[data-field*="telefone"]');
  phoneFields.forEach(el => {
    el.addEventListener('input', e => {
      e.target.value = maskPhone(e.target.value);
    });
  });
  
  // Aplicar m√°scaras de CPF
  const cpfFields = $$('input[data-field*="_cpf"], input[id*="cpf" i], input[name*="cpf" i]');
  cpfFields.forEach(el => {
    el.addEventListener('input', e => {
      e.target.value = maskCPF(e.target.value);
    });
  });
  
  // Aplicar m√°scaras de CNPJ
  const cnpjFields = $$('input[data-field*="_cnpj"], input[id*="cnpj" i], input[name*="cnpj" i]');
  cnpjFields.forEach(el => {
    el.addEventListener('input', e => {
      e.target.value = maskCNPJ(e.target.value);
    });
  });
});

// ============================================
// 8Ô∏è‚É£ FUN√á√ÉO CORRIGIDA: togglePaymentDetail
// ============================================

function togglePaymentDetail(type) {
  const detailIds = {
    'compravenda': 'paymentDetail_compravenda',
    'imovel': 'paymentDetail_imovel',
    'locacao': 'paymentDetail_locacao'
  };
  
  const detailId = detailIds[type];
  if (!detailId) return;
  
  const detailField = $(`#${detailId}`);
  if (!detailField) return;
  
  // Determinar qual select verificar baseado no tipo
  let selectId;
  switch(type) {
    case 'compravenda':
      selectId = 'formaPagamento';
      break;
    case 'imovel':
      selectId = 'formaPagamentoCV';
      break;
    case 'locacao':
      selectId = 'formaPagamentoLoc';
      break;
  }
  
  const selectEl = $(selectId ? `#${selectId}` : null);
  const hasValue = selectEl && selectEl.value && selectEl.value !== '';
  
  if (hasValue) {
    detailField.classList.add('show');
  } else {
    detailField.classList.remove('show');
  }
}

// ============================================
// 9Ô∏è‚É£ EXPORTAR GLOBALMENTE
// ============================================

window.maskCPF = maskCPF;
window.maskCNPJ = maskCNPJ;
window.maskPhone = maskPhone;
window.maskCurrency = maskCurrency;
window.normalizeTelefoneAPI = normalizeTelefoneAPI;
window.toTitleCase = toTitleCase;
window.togglePaymentDetail = togglePaymentDetail;
window.onlyDigits = onlyDigits;
window.isVisible = isVisible;
window.formatFileSize = formatFileSize;

// ============================================
// ‚úÖ FIM DO SCRIPT CONSOLIDADO
// ============================================
